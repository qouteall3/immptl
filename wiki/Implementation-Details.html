<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.43">
    <title>Implementation Details | Immersive Portals</title><meta name="description" content="It's Immersive Portals">
    <link rel="modulepreload" href="/immptl/assets/app.6c6fd354.js"><link rel="modulepreload" href="/immptl/assets/Implementation-Details.html.cfaaf67d.js"><link rel="modulepreload" href="/immptl/assets/Implementation-Details.html.f1b9118e.js"><link rel="prefetch" href="/immptl/assets/Download.html.68ce8cf5.js"><link rel="prefetch" href="/immptl/assets/index.html.01a3b2e3.js"><link rel="prefetch" href="/immptl/assets/API-for-Other-Mods.html.b04759b2.js"><link rel="prefetch" href="/immptl/assets/Commands-Reference.html.7631aeda.js"><link rel="prefetch" href="/immptl/assets/Config-Options.html.5a4d87c1.js"><link rel="prefetch" href="/immptl/assets/Datapack-Based-Custom-Portal-Generation.html.88ef8108.js"><link rel="prefetch" href="/immptl/assets/Dimension-Management.html.e25c02ae.js"><link rel="prefetch" href="/immptl/assets/Dimension-Stack.html.de833232.js"><link rel="prefetch" href="/immptl/assets/Miscellaneous.html.53f2445b.js"><link rel="prefetch" href="/immptl/assets/Portal-Attributes.html.0f43cd8a.js"><link rel="prefetch" href="/immptl/assets/Portal-Customization.html.2150344f.js"><link rel="prefetch" href="/immptl/assets/Portals.html.fe511100.js"><link rel="prefetch" href="/immptl/assets/index.html.df775c07.js"><link rel="prefetch" href="/immptl/assets/Spatial-Transformation.html.5fd60997.js"><link rel="prefetch" href="/immptl/assets/Download.html.2f6e14ef.js"><link rel="prefetch" href="/immptl/assets/index.html.8594d67d.js"><link rel="prefetch" href="/immptl/assets/404.html.f166316b.js"><link rel="prefetch" href="/immptl/assets/Download.html.d9b56aeb.js"><link rel="prefetch" href="/immptl/assets/index.html.17c93c11.js"><link rel="prefetch" href="/immptl/assets/API-for-Other-Mods.html.add068f1.js"><link rel="prefetch" href="/immptl/assets/Commands-Reference.html.985917a4.js"><link rel="prefetch" href="/immptl/assets/Config-Options.html.6bbc868f.js"><link rel="prefetch" href="/immptl/assets/Datapack-Based-Custom-Portal-Generation.html.eb2bef0a.js"><link rel="prefetch" href="/immptl/assets/Dimension-Management.html.8545abd4.js"><link rel="prefetch" href="/immptl/assets/Dimension-Stack.html.23214fab.js"><link rel="prefetch" href="/immptl/assets/Miscellaneous.html.b30340c2.js"><link rel="prefetch" href="/immptl/assets/Portal-Attributes.html.c6beb461.js"><link rel="prefetch" href="/immptl/assets/Portal-Customization.html.a26f9200.js"><link rel="prefetch" href="/immptl/assets/Portals.html.10d5e711.js"><link rel="prefetch" href="/immptl/assets/index.html.272a04b1.js"><link rel="prefetch" href="/immptl/assets/Spatial-Transformation.html.0612b224.js"><link rel="prefetch" href="/immptl/assets/Download.html.c97290cb.js"><link rel="prefetch" href="/immptl/assets/index.html.a4309797.js"><link rel="prefetch" href="/immptl/assets/404.html.f24145a5.js"><link rel="prefetch" href="/immptl/assets/404.0b668ea4.js"><link rel="prefetch" href="/immptl/assets/Layout.2df97a9f.js"><link rel="prefetch" href="/immptl/assets/CollapseTransition.a4ddc9fa.js"><link rel="prefetch" href="/immptl/assets/ModDownload.ba092379.js"><link rel="prefetch" href="/immptl/assets/SimpleAccordion.1ba10ee2.js">
    <link rel="stylesheet" href="/immptl/assets/style.e08e2a0e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-mix with-navbar"><header class="navbar"><div class="navbar-inner"><div class="site-brand"><div class="toggle-sidebar-button"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" shape-rendering="geometricPrecision" viewBox="0 0 24 24" height="1.5em" width="1.5em" style="color:currentcolor;"><path d="M3 12h18M3 6h18M3 18h18"></path></svg></div><a href="/immptl/" class=""><div class="logo-box logo-with-title"><img class="logo" src="/immptl/images/immptl.png" alt="VuePress Mix Theme Logo"></div><strong class="site-brand-title can-hide">Immersive Portals</strong></a></div><div class="navbar-links-wrapper can-hide"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Select language"><span class="arrow-down">Languages</span></button><button class="mobile-dropdown-title" type="button" aria-label="Select language"><span class="arrow-right">Languages</span></button><ul class="dropdown-menu"><!--[--><li class="dropdown-item"><a aria-current="page" href="/immptl/wiki/Implementation-Details.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English">English</a></li><li class="dropdown-item"><a href="/immptl/zh/" class="nav-link" aria-label="简体中文">简体中文</a></li><!--]--></ul><ul style="display:none;" class="mobile-dropdown-menu"><!--[--><li class="dropdown-item"><a aria-current="page" href="/immptl/wiki/Implementation-Details.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English">English</a></li><li class="dropdown-item"><a href="/immptl/zh/" class="nav-link" aria-label="简体中文">简体中文</a></li><!--]--></ul></div></div><!--]--></nav></div><div class="navbar-right"><div class="navbar-features"><div class="navbar-features-item"><button type="button" aria-label="Toggle theme mode"><svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" shape-rendering="geometricPrecision" width="1.5em" height="1.5em" viewbox="0 0 24 24" class="icon-sun" role="presentation" style="color:currentColor;"><!--[--><g><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></g><!--]--></svg></button></div></div><!----></div></div></header><div class="sidebar-mask"></div><div class="theme-layout"><aside class="sidebar"><div class="scrollbar"><div class="scrollbar-container"><!--[--><div class="scrollbar-content" style=""><!--[--><div class="navbar-links-wrapper"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Select language"><span class="arrow-down">Languages</span></button><button class="mobile-dropdown-title" type="button" aria-label="Select language"><span class="arrow-right">Languages</span></button><ul class="dropdown-menu"><!--[--><li class="dropdown-item"><a aria-current="page" href="/immptl/wiki/Implementation-Details.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English">English</a></li><li class="dropdown-item"><a href="/immptl/zh/" class="nav-link" aria-label="简体中文">简体中文</a></li><!--]--></ul><ul style="display:none;" class="mobile-dropdown-menu"><!--[--><li class="dropdown-item"><a aria-current="page" href="/immptl/wiki/Implementation-Details.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English">English</a></li><li class="dropdown-item"><a href="/immptl/zh/" class="nav-link" aria-label="简体中文">简体中文</a></li><!--]--></ul></div></div><!--]--></nav></div><div class="sidebar-inner"><ul class="sidebar-items"><!--[--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/" class="sidebar-item-link" aria-label="Home"><span class="sidebar-item-text">Home</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Portals.html" class="sidebar-item-link" aria-label="Portals"><span class="sidebar-item-text">Portals</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Portal-Customization.html" class="sidebar-item-link" aria-label="Portal Customization"><span class="sidebar-item-text">Portal Customization</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Spatial-Transformation.html" class="sidebar-item-link" aria-label="Spatial Transformation"><span class="sidebar-item-text">Spatial Transformation</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Datapack-Based-Custom-Portal-Generation.html" class="sidebar-item-link" aria-label="Datapack-based Custom Portal Generation"><span class="sidebar-item-text">Datapack-based Custom Portal Generation</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Dimension-Management.html" class="sidebar-item-link" aria-label="Dimension Management"><span class="sidebar-item-text">Dimension Management</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Dimension-Stack.html" class="sidebar-item-link" aria-label="Dimension Stack"><span class="sidebar-item-text">Dimension Stack</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Config-Options.html" class="sidebar-item-link" aria-label="Config Options"><span class="sidebar-item-text">Config Options</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Commands-Reference.html" class="sidebar-item-link" aria-label="Commands Reference"><span class="sidebar-item-text">Commands Reference</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Portal-Attributes.html" class="sidebar-item-link" aria-label="Portal Attributes"><span class="sidebar-item-text">Portal Attributes</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/Miscellaneous.html" class="sidebar-item-link" aria-label="Miscellaneous"><span class="sidebar-item-text">Miscellaneous</span></a></li><!--]--><!--[--><li class="sidebar-item"><a href="/immptl/wiki/API-for-Other-Mods.html" class="sidebar-item-link" aria-label="API for Other Mods"><span class="sidebar-item-text">API for Other Mods</span></a></li><!--]--><!--[--><li class="sidebar-item active"><a aria-current="page" href="/immptl/wiki/Implementation-Details.html" class="router-link-active router-link-exact-active sidebar-item-link" aria-label="Implementation Details"><span class="sidebar-item-text">Implementation Details</span></a></li><!--]--><!--]--></ul></div><!--]--></div><!--]--></div><div class="scrollbar-rail scrollbar-rail--vertical" aria-hidden="true"><!----></div><div class="scrollbar-rail scrollbar-rail--horizontal" aria-hidden="true"><!----></div></div></aside><main class="page"><div class="with-toc theme-mix-content-wrap"><div class="theme-mix-content"><!--[--><h1 id="implementation-details" tabindex="-1"><a class="header-anchor" href="#implementation-details" aria-hidden="true">#</a> Implementation Details</h1><h2 id="portal-rendering" tabindex="-1"><a class="header-anchor" href="#portal-rendering" aria-hidden="true">#</a> Portal Rendering</h2><p>There are two ways of rendering portal within the architecture of rasterization:</p><ol><li>Use stencil buffer to limit rendering area and render portals from outer to inner</li><li>Render portal content to another frame buffer first and then draw to the main frame buffer. Render inner portal first.</li></ol><p>This mod mainly adopts the first method. (It also has the &quot;compatibility&quot; rendering mode which uses the second method but does not support portal-in-portal rendering)</p><p>The portal rendering pseudocode:</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#22272e;"><code><span class="line"><span style="color:#adbac7;">renderWorld() {</span></span>
<span class="line"><span style="color:#adbac7;">    prepare</span></span>
<span class="line"><span style="color:#adbac7;">    render solid things</span></span>
<span class="line"><span style="color:#adbac7;">    renderPortals()</span></span>
<span class="line"><span style="color:#adbac7;">    render transparent things</span></span>
<span class="line"><span style="color:#adbac7;">}</span></span>
<span class="line"><span style="color:#adbac7;"></span></span>
<span class="line"><span style="color:#adbac7;">renderPortals() {</span></span>
<span class="line"><span style="color:#adbac7;">    if exceeds recursion limit, exit</span></span>
<span class="line"><span style="color:#adbac7;">    for each portal nearby {</span></span>
<span class="line"><span style="color:#adbac7;">        if portal is in frustum {</span></span>
<span class="line"><span style="color:#adbac7;">            render the portal shape with occlusion query</span></span>
<span class="line"><span style="color:#adbac7;">                with stencil func: equal to the portal layer</span></span>
<span class="line"><span style="color:#adbac7;">                with stencil operation: increment by 1</span></span>
<span class="line"><span style="color:#adbac7;">            predict the portal visibility (avoid waiting for occlusion query result)</span></span>
<span class="line"><span style="color:#adbac7;">            if the portal is deemed visible {</span></span>
<span class="line"><span style="color:#adbac7;">                outerStencil = current portal layer</span></span>
<span class="line"><span style="color:#adbac7;">                increment portal layer by 1</span></span>
<span class="line"><span style="color:#adbac7;">                with stencil func: equal to the portal layer, do:</span></span>
<span class="line"><span style="color:#adbac7;">                    clear depth</span></span>
<span class="line"><span style="color:#adbac7;">                    renderWorld() with new position, new dimension, new camera transformation</span></span>
<span class="line"><span style="color:#adbac7;">                        (will do recursion)</span></span>
<span class="line"><span style="color:#adbac7;">                    set depth value by portal shape</span></span>
<span class="line"><span style="color:#adbac7;">                    reset stencil value to outerStencil</span></span>
<span class="line"><span style="color:#adbac7;">                decrement portal layer by 1</span></span>
<span class="line"><span style="color:#adbac7;">            }</span></span>
<span class="line"><span style="color:#adbac7;">        }</span></span>
<span class="line"><span style="color:#adbac7;">    }</span></span>
<span class="line"><span style="color:#adbac7;">}</span></span>
<span class="line"><span style="color:#adbac7;"></span></span></code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>The outmost part of the framebuffer has stencil value 0. Rendering the portal area will increase stencil value by 1. So the stencil value corresponds to the portal layer.</p><p>That&#39;s only the main skeleton of portal rendering. Other details includes:</p><ul><li>Frustum culling optimization</li><li>Visibility prediction optimization</li><li>Enable <code>GL_DEPTH_CLAMP</code> for portal shape rendering. Or if the camera is close to the portal it will do wrong clipping.</li><li>Front clipping by transforming the shader code.</li><li>Because the portal rendering is recursive, all rendering related context should be switched upon rendering, stored on the stack, and then recover after the portal rendering finishes.</li><li>The face culling should be inversed when rendering odd number layers of mirrors (for example, 1, 3, 5 layers of mirrors).</li></ul><h3 id="frustum-culling-optimization" tabindex="-1"><a class="header-anchor" href="#frustum-culling-optimization" aria-hidden="true">#</a> Frustum Culling Optimization</h3><p>This mod use frustum culling optimization in 3 cases:</p><ul><li>To determine whether a portal is invisible before occlusion query rendering</li><li>To cull the invisible sections when rendering portal content (inner frustum culling)</li><li>To cull the things occluded by portal in the outer world (outer frustum culling)</li></ul><p>For example, when rendering this scene</p><figure><img src="https://s2.loli.net/2022/03/09/YqCFz4iHWe1JKG2.png" alt=""></figure><p>The sections occluded by the portal will be culled. (outer frustum culling)</p><figure><img src="https://s2.loli.net/2022/03/09/hNSXDQslVRWAz4n.png" alt=""></figure><p>The sections out of portal view will be culled (inner frustum culling)</p><figure><img src="https://s2.loli.net/2022/03/09/Pm4sNZqthdiDbRe.png" alt=""></figure><p>Without advanced frustum culling: <img src="https://s2.loli.net/2022/03/09/fMXYQVu7ShaqOsD.png" alt=""><img src="https://s2.loli.net/2022/03/09/1bZDdTIcHSUf7B5.png" alt=""></p><h3 id="front-clipping" tabindex="-1"><a class="header-anchor" href="#front-clipping" aria-hidden="true">#</a> Front Clipping</h3><p>When rendering portal content, everything in front of the portal plane will be clipped. The gold block in this image is in nether behind the portal.</p><figure><img src="https://s2.loli.net/2022/03/09/nwox68favZd1Ym2.png" alt=""></figure><p>If not correctly clipped, the portal will be rendered wrongly:</p><figure><img src="https://s2.loli.net/2022/03/09/i3QrLWzctq9kmjh.png" alt=""></figure><p>This mod do clipping by transforming the vertex shader and set <code>gl_ClipDistance</code>.</p><p>There is another clipping method using oblique projection. http://www.terathon.com/lengyel/Lengyel-Oblique.pdf</p><p>This mod does not use oblique projection for clipping because <strong>oblique projection cannot do correct clipping in all cases.</strong> If the angle between the culling plane normal with view vector is not bigger than 90 degrees, it will not work at all.</p><p>And oblique projection make it harder to be compatible with Iris.</p><h3 id="portal-visibility-prediction-optimization-utilizing-temporal-coherence" tabindex="-1"><a class="header-anchor" href="#portal-visibility-prediction-optimization-utilizing-temporal-coherence" aria-hidden="true">#</a> Portal Visibility Prediction Optimization Utilizing Temporal Coherence</h3><p>This mod use occlusion query to determine whether a portal is visible. Portal rendering is expensive so we need to only render visible portals.</p><p>However, occlusion query itself has cost. Taking an occlusion query result requires waiting for GPU to finish the previous rendering. Normally CPU and GPU works asynchronously, CPU don&#39;t need to wait for GPU finish the first draw call to submit the second draw call. The synchronization can cost a lot of performance.</p><p>This mod firstly submit the occlusion query and then predict the portal visibility from the old occlusion results, avoid waiting for the occlusion query result in most cases. The prediction is correct in most cases because of temporal coherence: a portal that&#39;s visible will likely to be visible in the next frame, vice versa. In case of successive prediction failure, it will automatically turn to conservative prediction mode. This will improve portal rendering performance in a scene with many portals.</p><h3 id="mirror-rendering" tabindex="-1"><a class="header-anchor" href="#mirror-rendering" aria-hidden="true">#</a> Mirror Rendering</h3><p>After applying one mirror transformation, all counter-clockwise triangles will become clockwise. So the face culling should be inverted. Applying two mirror transformations cancels that. The face culling will be inverted when rendering an odd number of layers of mirrors.</p><h3 id="other-portal-rendering-algorithms" tabindex="-1"><a class="header-anchor" href="#other-portal-rendering-algorithms" aria-hidden="true">#</a> Other Portal Rendering Algorithms</h3><p>As mentioned before, there are 2 ways to do portal rendering in rasterization. This mod uses the first method by default and also provides compatibility render mode that use the second method.</p><p>The first method is to limit the rendering area using stencil buffer. The second method firstly render the portal content into a framebuffer and then draw that framebuffer into the main framebuffer. The reason that this mod does not adopt the second method by default is that <strong>the second method does not allow accurate portal visibility detection by occlusion query</strong>.</p><p>This mod allows deep-nested portal. For example, this mirror room scene:</p><figure><img src="https://i.loli.net/2021/11/20/xs9Fb6JDjgWNRlh.png" alt=""></figure><p>This mirror room scene involves many portal-in-portal rendering. With the stencil buffer approach we can use occlusion query to accurately determine whether one portal is visible. But with the second method, it&#39;s hard to determine whether a portal-in-portal is visible so it will do a lot more unnecessary rendering.</p><p>The 2 methods above are all under the architecture of rasterization. With ray tracing, portal rendering is much simpler. If the ray hits a portal, just emit a new transformed ray. No clipping is required. And it will be much more efficent in rendering the mirror room scene.</p><h3 id="cross-portal-entity-rendering" tabindex="-1"><a class="header-anchor" href="#cross-portal-entity-rendering" aria-hidden="true">#</a> Cross Portal Entity Rendering</h3><p>If an entity is intersecting with a portal, to render this entity correctly, it will render the entity twice. The entity will be rendered both outside of the portal and inside portal with plane culling. Minecraft uses deferred entity rendering which firstly collects all triangles and then render all of them. This cannot handle the entity rendering that has a special culling plane. So it will first render all collected triangles and then use a separate draw call to render the culled entity.</p><p>For example, this sheep is partly in portal and partly outside of portal</p><figure><img src="https://s2.loli.net/2021/12/18/IHhBbXEmfosJ23x.png" alt=""></figure><h3 id="portal-rendering-merge-optimization" tabindex="-1"><a class="header-anchor" href="#portal-rendering-merge-optimization" aria-hidden="true">#</a> Portal Rendering Merge Optimization</h3><p>A scale box consists of 6 outer portals and 6 inner portals. Without the portal rendering merge feature, it may require 2 or 3 portal renderings to render a scale box. After merging the portals in a scale box, one scale box can be rendered in one portal rendering.</p><figure><img src="https://i.loli.net/2021/09/30/J9bBF82tRu5yIkW.png" alt=""></figure><h2 id="fundamental-changes-to-minecraft" tabindex="-1"><a class="header-anchor" href="#fundamental-changes-to-minecraft" aria-hidden="true">#</a> Fundamental Changes to Minecraft</h2><h3 id="eliminate-the-one-client-world-limitation" tabindex="-1"><a class="header-anchor" href="#eliminate-the-one-client-world-limitation" aria-hidden="true">#</a> Eliminate the One-Client-World Limitation</h3><p>Vanilla Minecraft only allows loading one dimension in client at once. This mod eliminates that limitation and changed many code that&#39;s built upon one-client-world assumption. To maintain minimal intrusive and maximum generality, this mod switches the client world context when invoking code associated with remote dimensions.</p><h3 id="eliminate-the-near-loading-limitation" tabindex="-1"><a class="header-anchor" href="#eliminate-the-near-loading-limitation" aria-hidden="true">#</a> Eliminate the Near-Loading Limitation</h3><p>Vanilla Minecraft only allows chunks nearby the player to be loaded. This mod&#39;s portal allows loading very far chunks, so this limitation must be eliminated. Vanilla use a fixed size array to store chunk references and chunk rendering info references. This mod changed them into maps.</p><h3 id="chunk-visibility-and-entity-visibility-tracking" tabindex="-1"><a class="header-anchor" href="#chunk-visibility-and-entity-visibility-tracking" aria-hidden="true">#</a> Chunk Visibility and Entity Visibility Tracking</h3><p>To do world information synchronization, the server must track the chunk visibility and entity visibility for every player. This mod rewrites chunk tracking algorithm. ImmPtl&#39;s chunk tracking algorithm updates periodically and searches for directly and indirectly visible portals. To mitigate the lag spikes, this mod&#39;s chunk tracking algorithm make it gradually loads chunks from near to far. Entity tracking mechanics also gets changed.</p><h3 id="networking-protocol-changes" tabindex="-1"><a class="header-anchor" href="#networking-protocol-changes" aria-hidden="true">#</a> Networking Protocol Changes</h3><p>The server needs to send packets to client to synchronize world informations (blocks, entiteis, etc.). All of these packets does not contain dimension information, so the client cannot discriminate these packets between dimensions.</p><p>To solve that, ImmPtl changed the networking protocol in a minimal intrusive way. It wraps world information packets into a &quot;redirected packet&quot; that contain dimension information, and the client will handle these packets with context switched.</p><h2 id="seamless-teleportation" tabindex="-1"><a class="header-anchor" href="#seamless-teleportation" aria-hidden="true">#</a> Seamless teleportation</h2><p>To make the teleportation seamless, this mod do client side teleportation before every frame&#39;s rendering (not during ticking). Teleportation happens when the camera crosses the portal (not after the player entity crossing the portal).</p><p>Teleportation is iterative. Normally the player at most teleports one time in a frame. But when the player crosses the world wrapping corner the teleportation may happen twice.</p><figure><img src="https://s2.loli.net/2021/12/18/agoqwc7NTQ9YizU.png" alt=""></figure><h3 id="the-mutual-synchronization-of-player-position" tabindex="-1"><a class="header-anchor" href="#the-mutual-synchronization-of-player-position" aria-hidden="true">#</a> The Mutual Synchronization of Player Position</h3><p>In most cases the server accept client position information. This mod make that position information contain dimension information. And the server must validate the client position to avoid cheating. In some cases, the client accepts position information from the server, for example when a teleportation command executes. The position synchronization is mutual, so it become a little bit complex.</p><h2 id="how-portals-are-stored" tabindex="-1"><a class="header-anchor" href="#how-portals-are-stored" aria-hidden="true">#</a> How Portals are Stored</h2><p>Although nether portals seems be aligned with blocks, this mod does not limit the portals to be aligned with blocks. Portals are entities, not blocks.</p><p>This mod&#39;s portal can be tilted, can be in any shape, can be arbitrarily big (global portals), can be anywhere, can point to any dimension, can point to anywhere, and can have any rotation transformation, scale transformation.</p><p>One portal entity corresponds to a one-way one-faced portal. A normal bi-way, bi-faced nether portal contains 4 portal entities.</p><p>This mod also provide global portal mechanic that allows very big portals. The global portals are stored in per-dimension world data. Dimension stack portals and world wrapping portals are all global portals. Global portals are always loaded, so they can be very big.</p><h2 id="other-cross-portal-mechanics" tabindex="-1"><a class="header-anchor" href="#other-cross-portal-mechanics" aria-hidden="true">#</a> Other Cross-Portal Mechanics</h2><h3 id="cross-portal-collision" tabindex="-1"><a class="header-anchor" href="#cross-portal-collision" aria-hidden="true">#</a> Cross Portal Collision</h3><p>ImmPtl has cross-portal collision. In this scene, the creeper is in overworld (because its eye position is in overworld) but it&#39;s standing on a glass block in nether.</p><figure><img src="https://s2.loli.net/2021/12/18/nJrN5oKib1dteVm.png" alt=""></figure><p>When an entity is halfway in the portal then its collision will be specially treated.</p><p>It will cut the entity&#39;s collision into two pieces, one outside portal and one inside portal. It firstly does collision test for the outer part and then switch the entity to the portal destination position and do collision test for the inner part.</p><h3 id="cross-portal-sound" tabindex="-1"><a class="header-anchor" href="#cross-portal-sound" aria-hidden="true">#</a> Cross Portal Sound</h3><p>ImmPtl allows you to hear the sound through portal. To calculate the sound volume, it will find the sound &quot;trajectory&quot;. It firstly finds the nearest point on the portal from the sound source, and then teleport through the portal on that point and then go into the player.</p><h3 id="cross-portal-block-breaking-and-placement" tabindex="-1"><a class="header-anchor" href="#cross-portal-block-breaking-and-placement" aria-hidden="true">#</a> Cross Portal Block Breaking and Placement</h3><p>This mod supports cross-portal block breaking and placement. It can even place blocks across a portal.</p><p>For example, in this dimension stack scene, placing a block upon the top nether will actually place the block to the bottom of overworld.</p><figure><img src="https://s2.loli.net/2021/12/18/kPdh7RjqvtTFlY3.png" alt=""></figure><h2 id="other" tabindex="-1"><a class="header-anchor" href="#other" aria-hidden="true">#</a> Other</h2><h3 id="handling-rotation-animation-and-gravity-change" tabindex="-1"><a class="header-anchor" href="#handling-rotation-animation-and-gravity-change" aria-hidden="true">#</a> Handling Rotation Animation and Gravity Change</h3><p>If the player cross a portal with rotation transformation, its camera rotation may become tilted which is not a valid camera transformation. To make the teleportation seamless, this mod will do a smooth camera rotation transition. It involves some quaternion math. If gravity changer mod is present, it will take gravity rotations into consideration.</p><h3 id="portal-frame-matching" tabindex="-1"><a class="header-anchor" href="#portal-frame-matching" aria-hidden="true">#</a> Portal Frame Matching</h3><p>This mod supports any-shaped nether portal (with size limit) and also supports adaptive matching for non-square portals. For example, these two L-shaped portals can match, although their scale and rotation are different.</p><figure><img src="https://s2.loli.net/2021/12/18/KqDJszQhZGWVmIM.png" alt=""></figure><!--]--><div class="page-meta"><!----><div class="last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">6/13/2022, 4:01:00 PM</span></div></div><nav class="page-nav"><div class="inner"><span class="prev"> ← <a href="/immptl/wiki/API-for-Other-Mods.html" class="nav-link" aria-label="API for Other Mods">API for Other Mods</a></span><!----></div></nav></div><div class="toc-wrap"><div class="scrollbar"><div class="scrollbar-container"><!--[--><div class="scrollbar-content" style=""><!--[--><div class="theme-mix-toc"><div class="toc-mask"></div><button class="mobile-toc-title"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" shape-rendering="geometricPrecision" viewbox="0 0 24 24" height="1.5em" width="1.5em" style="color:currentcolor;"><path d="M21 10H7M21 6H3M21 14H3M21 18H7"></path></svg></button><div class="toc-items-wrap"><ul class="toc-items"><!--[--><li class="toc-item toc-level-2"><a class="toc-anchor" href="#portal-rendering">Portal Rendering</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#frustum-culling-optimization">Frustum Culling Optimization</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#front-clipping">Front Clipping</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#portal-visibility-prediction-optimization-utilizing-temporal-coherence">Portal Visibility Prediction Optimization Utilizing Temporal Coherence</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#mirror-rendering">Mirror Rendering</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#other-portal-rendering-algorithms">Other Portal Rendering Algorithms</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#cross-portal-entity-rendering">Cross Portal Entity Rendering</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#portal-rendering-merge-optimization">Portal Rendering Merge Optimization</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#fundamental-changes-to-minecraft">Fundamental Changes to Minecraft</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#eliminate-the-one-client-world-limitation">Eliminate the One-Client-World Limitation</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#eliminate-the-near-loading-limitation">Eliminate the Near-Loading Limitation</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#chunk-visibility-and-entity-visibility-tracking">Chunk Visibility and Entity Visibility Tracking</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#networking-protocol-changes">Networking Protocol Changes</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#seamless-teleportation">Seamless teleportation</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#the-mutual-synchronization-of-player-position">The Mutual Synchronization of Player Position</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#how-portals-are-stored">How Portals are Stored</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#other-cross-portal-mechanics">Other Cross-Portal Mechanics</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#cross-portal-collision">Cross Portal Collision</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#cross-portal-sound">Cross Portal Sound</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#cross-portal-block-breaking-and-placement">Cross Portal Block Breaking and Placement</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#other">Other</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#handling-rotation-animation-and-gravity-change">Handling Rotation Animation and Gravity Change</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#portal-frame-matching">Portal Frame Matching</a></li><!--]--></ul></div></div><!--]--></div><!--]--></div><div class="scrollbar-rail scrollbar-rail--vertical" aria-hidden="true"><!----></div><div class="scrollbar-rail scrollbar-rail--horizontal" aria-hidden="true"><!----></div></div></div></div></main></div></div><!----><!--]--></div>
    <script type="module" src="/immptl/assets/app.6c6fd354.js" defer></script>
  </body>
</html>
